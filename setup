# setup omni integrators workbench environment

if [ $(uname) = "Darwixn" ]; then exit 1;fi

# Calculate and Get the Latest Copy of 
if [ ! -f "./ism/omni.zip" ]; then
   iomni=http://iomnibld:8081/nexus/content/repositories/snapshots/com/iwaysoftware/omni/Workbench/2.0.0-SNAPSHOT
   curl -o maven-metadata.xml $iomni/maven-metadata.xml
   ts=$(cat maven-metadata.xml | grep '<timestamp'   | cut -f2 -d">"|cut -f1 -d"<")
   bn=$(cat maven-metadata.xml | grep '<buildNumber' | cut -f2 -d">"|cut -f1 -d"<")

   echo Getting Workbench-2.0.0-$ts-$bn.zip as omni.zip
   curl -o ./ism/omni.zip $iomni/Workbench-2.0.0-$ts-$bn.zip
   rm maven-metadata.xml
fi


# Unzip omni if needed
[ ! -d "./ism/OmniPatient" ] && unzip -d ./ism/ -q ./ism/omni.zip


# Create & start the Machine if its not there
boot2docker init
boot2docker start
boot2docker ip
boot2docker ssh "[ ! -f /home/docker/omnidock ] && (ln -s $HOME/omnidock /home/docker/omnidock)"

if [ "$OS" == "Windows_NT" ]; then

   # Add a script to get to ism
   if [ ! -f "$HOMEDRIVE$HOMEPATH\Desktop\ismShell.lnk" ]; then
      echo "#!/bin/bash" > ssh2ism.sh 
      echo "ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no $(boot2docker ip):9022" >> ssh2ism.sh

      cat > CreateShortcut.vbs << EOF
      Set oWS = WScript.CreateObject("WScript.Shell")
      Set oLink = oWS.CreateShortcut("$HOMEDRIVE$HOMEPATH\Desktop\ismShell.lnk")
      oLink.TargetPath = "$PROGRAMFILES\Git\bin\sh.exe"
      oLink.Arguments="--login -i ssh2ism.sh"
      oLink.WorkingDirectory ="$HOMEDRIVE$HOMEPATH\omnidock"
      oLink.Save
EOF
      cscript //nologo CreateShortcut.vbs
      rm CreateShortcut.vbs
   fi
 
   # Create Shortcut to working dir
   if [ ! -f "$HOMEDRIVE$HOMEPATH\Desktop\Omni Integrators WorkBench.lnk" ]; then
      cat >  CreateShortcut.vbs << EOF
      Set oWS = WScript.CreateObject("WScript.Shell")
      Set oLink = oWS.CreateShortcut("$HOMEDRIVE$HOMEPATH\Desktop\Omni Integrators WorkBench.lnk")
      oLink.TargetPath = "$SYSTEMROOT\explorer.exe"
      oLink.Arguments="$HOMEDRIVE$HOMEPATH\omnidock\ism\OmniPatient"
      oLink.Save
EOF
      cscript //nologo CreateShortcut.vbs
      rm CreateShortcut.vbs
   fi
   
fi

boot2docker ssh

