# Setup omni integrators workbench environment
echo
echo "Running on $(uname)"
echo


# add a script to get from git
cat > upgrade << EOF
# some useful aliases - activate by "source ./upgrade"
alias d-ps='docker ps'
alias d-images='docker images'
alias d-cleanall='docker images -q | xargs docker rmi 2>/dev/null'
alias d-down='docker ps -q | xargs docker stop'


echo $1
[ "\$1" = "cleanall" ] && rm -rf ./ism/OmniPatient ./ism/omni.zip ./postgres/omnidb.tar

echo 'update from git'
git config --global core.autocrlf input
git pull
echo
EOF
chmod +x upgrade


# add shell links on windows
if [ "$OS" == "Windows_NT" ]; then

   # remove shell link
   [ -f "$HOMEDRIVE$HOMEPATH\Desktop\ismShell.lnk" ] && rm "$HOMEDRIVE$HOMEPATH\Desktop\ismShell.lnk"
    
   # Create Shortcut to working dir
   if [ ! -f "$HOMEDRIVE$HOMEPATH\Desktop\Omni Integrators WorkBench.lnk" ]; then
      cat >  CreateShortcut.vbs << EOF
      Set oWS = WScript.CreateObject("WScript.Shell")
      Set oLink = oWS.CreateShortcut("$HOMEDRIVE$HOMEPATH\Desktop\Omni Integrators WorkBench.lnk")
      oLink.TargetPath = "$SYSTEMROOT\explorer.exe"
      oLink.Arguments="$HOMEDRIVE$HOMEPATH\omnidock\ism\OmniPatient"
      oLink.Save
EOF
      cscript //nologo CreateShortcut.vbs
      rm CreateShortcut.vbs
   fi

else
   OS=$(uname)   
fi


# start boot2docker
boot2docker version 2>/dev/null
if [ ! "$OS" == "Linux" ]; then
   
   boot2docker init
   boot2docker start
   
   # clean up some stuff
   boot2docker ssh "[ -f log.log ] && rm log.log" 2>/dev/null
   boot2docker ssh "[ -f boot2docker,\ please\ format-me ] && rm boot2docker,\ please\ format-me" 2>/dev/null

   # setup docker from host environment   
   boot2docker shellinit > env.sh 
   chmod +x env.sh 
   ./env.sh 
   rm env.sh

   # link in omnidock (for now)
   hdo="/home/docker/omnidock"
   linkod="ln -Tfs $HOME/omnidock $hdo"
   if [ ! "$1" == "" ]; then linkod="ln -Tfs $1 $hdo";fi
   boot2docker ssh "if [ ! -d $hdo ]; then $linkod;fi"
   
   boot2docker ip   
   boot2docker ssh
fi
echo

