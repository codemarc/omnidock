#
# Setup omni integrators workbench environment
#
[ ! "$OS" == "Windows_NT" ] && OS=$(uname)
echo
echo "Running on $OS"

# Set home to a better place, just in case we are in the domain
([ ! "$USERPROFILE" == "" ] && [ ! "$HOME" == "$USERPROFILE" ]) && export HOME=$USERPROFILE

# Set the omnidock location to a known place
ODOCK=$HOME/omnidock

# Add to update the omnidock files
mkdir -p $ODOCK && cd $ODOCK

# Generate the update next upgrade script in the $ODOCK directory
cat > upgrade << EOF
# update files from github
echo 'update from git'
git config --global core.autocrlf input
git pull
echo
EOF

# make the script runnable
chmod +x upgrade



# start boot2docker
if [ ! "$OS" == "Linux" ]; then

   # Check version, initialize and start
   boot2docker version 2>/dev/null
   boot2docker init
   boot2docker start
   
   bip=$(boot2docker ip)
   echo boot2docker-vm ip is $bip
   
   # add odin as a registry if neccessary
   $(boot2docker ssh "[ -f /var/lib/boot2docker/profile ]" 2>/dev/null)
   if [ $? -gt 0 ]; then 
      boot2docker ssh 'sudo sh -c "echo \"EXTRA_ARGS=\\\"--insecure-registry odin.ibi.com:5000\\\"\" > /var/lib/boot2docker/profile"'
      boot2docker ssh 'sudo /etc/init.d/docker stop && sudo /etc/init.d/docker start'
   fi
   
   # clean up some stuff
   boot2docker ssh "[ -f log.log ] && rm log.log" 2>/dev/null
   boot2docker ssh "[ -f boot2docker,\ please\ format-me ] && rm boot2docker,\ please\ format-me" 2>/dev/null

   # setup docker from host environment   
   boot2docker shellinit > ./setenv 
   chmod +x ./setenv
   ./setenv
   echo 'export HOME=$USERPROFILE' >> ./setenv
   echo 'export PS1="\u@\h:\w\n\$ "' >> ./setenv
   echo '$SHELL' >> ./setenv
   
   # link in omnidock
   hdo="/home/docker/omnidock"
   boot2docker ssh "if [ ! -d $hdo ]; then ln -Tfs $(pwd) $hdo;fi"


   # windows stuff
   if [ "$OS" == "Windows_NT" ]; then
   
      # Note: The following steps are meant as a temporary solution and may not be 
      # needed in future version of this script
      vbm="$PROGRAMW6432\\Oracle\\VirtualBox\\VBoxManage"
      
      if [ "$(boot2docker status)" == "running" ]; then
         "$vbm" controlvm "boot2docker-vm" natpf1 "tcp-port5432,tcp,127.0.0.1,5432,,5432" 2>/dev/null
         "$vbm" controlvm "boot2docker-vm" natpf1 "tcp-port9999,tcp,127.0.0.1,9999,,9999" 2>/dev/null
         "$vbm" controlvm "boot2docker-vm" natpf1 "tcp-port9000,tcp,127.0.0.1,9000,,9000" 2>/dev/null
         "$vbm" controlvm "boot2docker-vm" natpf1 "tcp-port9001,tcp,127.0.0.1,9001,,9001" 2>/dev/null
         "$vbm" controlvm "boot2docker-vm" natpf1 "tcp-port9001,tcp,127.0.0.1,9022,,9022" 2>/dev/null
         "$vbm" controlvm "boot2docker-vm" natpf1 "tcp-port9502,tcp,127.0.0.1,9502,,9502" 2>/dev/null
         "$vbm" controlvm "boot2docker-vm" natpf1 "tcp-port9504,tcp,127.0.0.1,9504,,9504" 2>/dev/null
         "$vbm" controlvm "boot2docker-vm" natpf1 "tcp-port9506,tcp,127.0.0.1,9506,,9506" 2>/dev/null
      fi
   
      # remove old shell links
      [ -f "$HOME\Desktop\Omni Integrators WorkBench.lnk" ] && rm "$HOME\Desktop\Omni Integrators WorkBench.lnk"
      [ -f "$HOME\Desktop\Omni Consoles.url" ] && rm "$HOME\Desktop\Omni Consoles.url"
      [ -f "$HOME\Desktop\OmniPatient Service Monitor.url" ] && rm "$HOME\Desktop\OmniPatient Service Monitor.url"
      [ -f "$HOME\Desktop\OmniDock.lnk" ] && rm "$HOME\Desktop\OmniDock.lnk"
    
      # Create Shortcut to working dir
      cat >  CreateShortcuts.vbs << EOF
      Set oWS = WScript.CreateObject("WScript.Shell")
      Set oLink = oWS.CreateShortcut("$HOME\Desktop\Omni Integrators WorkBench.lnk")
      oLink.TargetPath = "$SYSTEMROOT\explorer.exe"
      oLink.Arguments="$USERPROFILE\omnidock\data"
      oLink.Save
      
      Set oLink = oWS.CreateShortcut("$HOME\Desktop\OmniDock.lnk")
      oLink.Description = "OmniDock Shell"
      oLink.TargetPath = "sh"
      oLink.Arguments="-login -i setenv"
      oLink.WorkingDirectory="$USERPROFILE\omnidock"
      oLink.Save
      
      Set oLink = oWS.CreateShortcut("$HOME\Desktop\Omni Consoles.url")
      oLink.TargetPath = "file:///$USERPROFILE/omnidock/index.html"
      oLink.Save
      
EOF
      cscript //nologo CreateShortcuts.vbs
      rm CreateShortcuts.vbs
   fi
   
   boot2docker ssh

else
   # Linux only
   uname -snrm
   lsb_release -irc 2>/dev/null
   echo
   
   echo "Checking for /var/lib/boot2docker"
   if [ -e /var/lib/boot2docker ]; then
      echo "Found, now checking for /var/lib/boot2docker/profile"
      if [ ! -f /var/lib/boot2docker/profile ]; then
         echo "Not found, /var/lib/boot2docker/profile"
         
         echo "Stopping docker deamon"
         sudo /etc/init.d/docker stop
         
         echo "Creating /var/lib/boot2docker/profile"
         sudo sh -c "echo \"EXTRA_ARGS='--insecure-registry odin.ibi.com:5000' \" > /var/lib/boot2docker/profile"
         
         echo "Starting docker deamon"
         sudo /etc/init.d/docker start
         
      else
         echo "Found, now checking for odin.ibi.com:5000 in /var/lib/boot2docker/profile"
         if [ $(cat /var/lib/boot2docker/profile | grep "odin.ibi.com:5000" | wc -w) -eq 0 ]; then
            echo "Not found, Stopping docker deamon"
            sudo /etc/init.d/docker stop
            
            echo "Updating /var/lib/boot2docker/profile"
            sed -i "s/EXTRA_ARGS='/EXTRA_ARGS='--insecure-registry odin.ibi.com:5000 /" /var/lib/boot2docker/profile
            
            echo "Starting docker deamon"
            sudo /etc/init.d/docker start
            
         else
            echo "good to go"
         fi
         
      fi
   else
   	  echo "Not found, probably NOT a boot2docker image"
   fi
   
fi
echo

