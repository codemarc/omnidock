#
# Setup omni integrators workbench environment
#
[ ! "$OS" == "Windows_NT" ] && OS=$(uname)
echo
echo "Running on $OS"

# Set home to a better place, just in case we are in the domain
([ ! "$USERPROFILE" == "" ] && [ ! "$HOME" == "$USERPROFILE" ]) && export HOME=$USERPROFILE

# Set the omnidock location
if [ "$1" == "" ]; then ODOCK=$HOME/omnidock;else ODOCK=$1;fi
 
# add a to update the omnidock files
mkdir -p $ODOCK && cd $ODOCK

cat > upgrade << EOF
# some useful aliases - activate by "source ./upgrade"
alias d-cleanall='docker images -q | xargs docker rmi 2>/dev/null'
alias d-down='docker ps -q | xargs docker stop'

# create some missing directories
mkdir -p data data/input/in1 data/debug

# update files from github
echo 'update from git'
git config --global core.autocrlf input
git pull
echo
EOF

# make the script runnable and run it
chmod +x upgrade
./upgrade


# start boot2docker
if [ ! "$OS" == "Linux" ]; then
   boot2docker version 2>/dev/null
   
   boot2docker init
   boot2docker start
   
   # clean up some stuff
   boot2docker ssh "[ -f log.log ] && rm log.log" 2>/dev/null
   boot2docker ssh "[ -f boot2docker,\ please\ format-me ] && rm boot2docker,\ please\ format-me" 2>/dev/null

   # setup docker from host environment   
   boot2docker shellinit > env.sh 
   chmod +x env.sh 
   ./env.sh 
   rm env.sh

   # link in omnidock
   hdo="/home/docker/omnidock"
   boot2docker ssh "if [ ! -d $hdo ]; then ln -Tfs $(pwd) $hdo;fi"

   # add odin as a registry
   boot2docker ssh 'sudo sh -c "echo \"EXTRA_ARGS=\\\"--insecure-registry odin.ibi.com:5000\\\"\" > /var/lib/boot2docker/profile && sudo /etc/init.d/docker restart"'
      
   bip=$(boot2docker ip)
   echo $bip
   
   # add shell links on windows
   if [ "$OS" == "Windows_NT" ]; then
      # remove old shell links
      [ -f "$HOME\Desktop\Omni Integrators WorkBench.lnk" ] && rm "$HOME\Desktop\Omni Integrators WorkBench.lnk"
      [ -f "$HOME\Desktop\OmniPatient Service Monitor.url" ] && rm "$HOME\Desktop\OmniPatient Service Monitor.url"
    
      # Create Shortcut to working dir
      cat >  CreateShortcuts.vbs << EOF
      Set oWS = WScript.CreateObject("WScript.Shell")
      Set oLink = oWS.CreateShortcut("$HOME\Desktop\Omni Integrators WorkBench.lnk")
      oLink.TargetPath = "$SYSTEMROOT\explorer.exe"
      oLink.Arguments="$ODOCK\data"
      oLink.Save
      Set oLink = oWS.CreateShortcut("$HOME\Desktop\OmniPatient Service Monitor.url")
      oLink.TargetPath = "http://$bip:9999/ism/appc?configuration=OmniPatient"
      oLink.Save
EOF
      cscript //nologo CreateShortcuts.vbs
      rm CreateShortcuts.vbs
   fi
   
   boot2docker ssh
fi
echo

